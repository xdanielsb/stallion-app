<div class="camera-app">
  <header class="app-header">
    <h1>{{ title() }}</h1>
    <p>Camera feed for image capture and inference</p>
  </header>
  
  <main class="camera-container">
    <div class="video-wrapper">
      <!-- Video element always rendered but visibility controlled -->
      <video 
        #videoElement 
        autoplay 
        playsinline 
        muted
        [class.visible]="isCameraActive() && !useFallbackImage()"
        class="camera-feed">
      </video>
      
      <!-- Bounding Box Overlay -->
      @if (isCameraActive() && boundingBoxes().length > 0) {
        <div class="bounding-box-overlay">
          @for (box of boundingBoxes(); track box) {
            <div
              class="bounding-box"
              [style.left]="useFallbackImage() ? (box.x1 / canvasElement.width * 100) + '%' : (box.x1 / videoElement.videoWidth * 100) + '%'"
              [style.top]="useFallbackImage() ? (box.y1 / canvasElement.height * 100) + '%' : (box.y1 / videoElement.videoHeight * 100) + '%'"
              [style.width]="useFallbackImage() ? ((box.x2 - box.x1) / canvasElement.width * 100) + '%' : ((box.x2 - box.x1) / videoElement.videoWidth * 100) + '%'"
              [style.height]="useFallbackImage() ? ((box.y2 - box.y1) / canvasElement.height * 100) + '%' : ((box.y2 - box.y1) / videoElement.videoHeight * 100) + '%'"
              [title]="'${box.label} (' + (box.confidence * 100).toFixed(1) + '%)'">
              <span class="bounding-box-label">{{ box.label }} {{ (box.confidence * 100).toFixed(1) }}%</span>
            </div>
          }
        </div>
      }
      
      <!-- Overlay elements that show/hide based on state -->
      @if (isCapturing()) {
        <div class="loading-spinner">
          <div class="spinner"></div>
          <p>Initializing camera...</p>
        </div>
      } @else if (errorMessage() && !useFallbackImage()) {
        <div class="error-message">
          <div class="error-icon">‚ö†Ô∏è</div>
          <h2>Camera Error</h2>
          <p>{{ errorMessage() }}</p>
          <button class="retry-button" (click)="initializeCamera()">Retry</button>
        </div>
      } @else if (!isCameraActive()) {
        <div class="camera-off">
          <div class="camera-icon">üì∑</div>
          <p>Camera is off</p>
          <button class="start-button" (click)="initializeCamera()">Start Camera</button>
        </div>
      }
      
      <!-- Controls only show when camera is active -->
      @if (isCameraActive()) {
        <div class="camera-controls">
          <button class="capture-button" (click)="autoCapture()">
            <span class="capture-icon"></span>
            Capture Now
          </button>
          <button class="auto-capture-button" 
                  [class.active]="isAutoCapturing()" 
                  (click)="toggleAutoCapture()">
            <span class="auto-icon" [class.spinning]="isAutoCapturing()"></span>
            Auto: {{ isAutoCapturing() ? 'ON' : 'OFF' }}
            @if (processedCount() > 0) {
              <span class="capture-count">({{ processedCount() }})</span>
            }
          </button>
          <button class="stop-button" (click)="stopCamera()">
            Stop Camera
          </button>
        </div>
      }
      
      <!-- Fallback image banner -->
      @if (useFallbackImage()) {
        <div class="fallback-banner">
          <span>Camera not found ‚Äî using generated test image</span>
        </div>
      }

      <!-- Canvas for image capture (visible in fallback mode, hidden otherwise) -->
      <canvas #canvasElement [class.visible]="useFallbackImage()" [class.hidden]="!useFallbackImage()" class="fallback-canvas"></canvas>
    </div>
    
    <!-- Image Processing Results -->
    @if (processingStatus()) {
      <div class="processing-results" 
           [class.success]="processingStatus()?.success" 
           [class.error]="!processingStatus()?.success">
        <h3>üñºÔ∏è Image Processing</h3>
        <p class="status-message">{{ processingStatus()?.message }}</p>
      </div>
    }
    
    @if (isAutoCapturing()) {
      <div class="auto-capture-indicator">
        <div class="pulse-dot"></div>
        <span>Live Auto-Capture Active</span>
      </div>
    }
    
    <!-- Statistics Display -->
    @if (processedCount() > 0) {
      <div class="stats-panel">
        <h3>üìà Processing Statistics</h3>
        <div class="stats-grid">
          <div class="stat-item">
            <span class="stat-label">Images Processed</span>
            <span class="stat-value primary">{{ processedCount() }}</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Last Response</span>
            <span class="stat-value" [class.fast]="lastResponseTime() < 500" [class.medium]="lastResponseTime() >= 500 && lastResponseTime() < 1000" [class.slow]="lastResponseTime() >= 1000">
              {{ lastResponseTime() }}ms
            </span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Average Response</span>
            <span class="stat-value" [class.fast]="averageResponseTime() < 500" [class.medium]="averageResponseTime() >= 500 && averageResponseTime() < 1000" [class.slow]="averageResponseTime() >= 1000">
              {{ averageResponseTime() }}ms
            </span>
          </div>
        </div>
        <div class="stats-actions">
          <button class="reset-stats-button" (click)="resetStatistics()">
            Reset Stats
          </button>
        </div>
      </div>
    }
    
    @if (imageInfo() || colorInfo()) {
      <div class="image-info">
        <h3>üìä Image Analysis Results</h3>
        
        @if (imageInfo()) {
          <div class="info-section">
            <h4>üñºÔ∏è Image Information</h4>
            <div class="info-grid">
              <div class="info-item">
                <span class="label">Dimensions:</span>
                <span class="value">{{ imageInfo()!.width }} √ó {{ imageInfo()!.height }}</span>
              </div>
              <div class="info-item">
                <span class="label">Format:</span>
                <span class="value">{{ imageInfo()!.format }}</span>
              </div>
              <div class="info-item">
                <span class="label">Size:</span>
                <span class="value">{{ formatFileSize(imageInfo()!.size_bytes) }} KB</span>
              </div>
              <div class="info-item">
                <span class="label">Aspect Ratio:</span>
                <span class="value">{{ imageInfo()!.aspect_ratio.toFixed(2) }}</span>
              </div>
            </div>
          </div>
        }
        
        @if (colorInfo()) {
          <div class="info-section">
            <h4>üé® Color Information</h4>
            <div class="info-grid">
              <div class="info-item">
                <span class="label">Dominant Color:</span>
                <div class="color-display">
                  <div class="color-box" 
                       [style.background-color]="colorInfo()!.dominant_color"></div>
                  <span class="value">{{ colorInfo()!.dominant_color }}</span>
                </div>
              </div>
              <div class="info-item">
                <span class="label">Grayscale:</span>
                <span class="value" [class.grayscale]="colorInfo()!.is_grayscale">
                  {{ colorInfo()!.is_grayscale ? 'Yes' : 'No' }}
                </span>
              </div>
              <div class="info-item">
                <span class="label">Transparency:</span>
                <span class="value">
                  {{ colorInfo()!.has_transparency ? 'Yes' : 'No' }}
                </span>
              </div>
            </div>
          </div>
        }
        
        @if (boundingBoxes().length > 0) {
          <div class="info-section">
            <h4>üéØ Detected Objects ({{ boundingBoxes().length }})</h4>
            <div class="objects-list">
              @for (box of boundingBoxes(); track box; let i = $index) {
                <div class="object-item">
                  <span class="object-index">{{ i + 1 }}</span>
                  <div class="object-details">
                    <span class="object-label">{{ box.label }}</span>
                    <span class="object-confidence">{{ (box.confidence * 100).toFixed(1) }}%</span>
                    <span class="object-coords">x:{{ box.x1.toFixed(0) }},y:{{ box.y1.toFixed(0) }} w:{{ (box.x2 - box.x1).toFixed(0) }}h:{{ (box.y2 - box.y1).toFixed(0) }}</span>
                  </div>
                </div>
              }
            </div>
          </div>
        }
      </div>
    }
  </main>
</div>